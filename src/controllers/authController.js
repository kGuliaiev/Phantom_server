// src/controllers/authController.js
import User from '../models/users.js';
import jwt from 'jsonwebtoken';
import bcrypt from 'bcrypt';
import crypto from 'crypto';

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Base64
const toBase64 = (str) => Buffer.from(str, 'utf-8').toString('base64');

// ðŸ” Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ base64
const isBase64 = (str) => {
    return typeof str === 'string' && /^[A-Za-z0-9+/=]+$/.test(str) && str.length % 4 === 0;
  };
  
  // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸
  export const registerUser = async (req, res) => {
    try {
      const { username, password, identifier, publicKey, identityKey, signedPreKey, oneTimePreKeys } = req.body;
  
      console.log('\nðŸ“ ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ');
      console.log('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ:', {
        username,
        identifier,
        publicKey,
        identityKey,
        signedPreKey,
        oneTimePreKeys: Array.isArray(oneTimePreKeys) ? oneTimePreKeys.length : 'Ð½Ðµ Ð¼Ð°ÑÑÐ¸Ð²'
      });
  
      if (!username || !password || !identifier || !publicKey || !identityKey || !signedPreKey || !oneTimePreKeys) {
        console.log('âŒ ÐÐµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ñ‹');
        return res.status(400).json({ message: 'Ð’ÑÐµ Ð¿Ð¾Ð»Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹ Ð´Ð»Ñ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸' });
      }
  
      if (!isBase64(publicKey) || !isBase64(identityKey) || !isBase64(signedPreKey)) {
        console.log('âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¸Ð· ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ð½ÐµÐ²ÐµÑ€ÐµÐ½ (Ð½Ðµ Base64)');
        return res.status(400).json({ message: 'ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÐºÐ»ÑŽÑ‡ÐµÐ¹ (Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Base64)' });
      }
  
      if (!Array.isArray(oneTimePreKeys) || oneTimePreKeys.some(k => !isBase64(k))) {
        console.log('âŒ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¸Ð· Ð¾Ð´Ð½Ð¾Ñ€Ð°Ð·Ð¾Ð²Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ð½ÐµÐ²ÐµÑ€ÐµÐ½');
        return res.status(400).json({ message: 'ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ð´Ð½Ð¾Ñ€Ð°Ð·Ð¾Ð²Ñ‹Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹' });
      }
  
      const existingUsername = await User.findOne({ username });
      if (existingUsername) {
        console.log('âš ï¸ Username ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚:', username);
        return res.status(409).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ñ‚Ð°ÐºÐ¸Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚' });
      }
  
      const existingIdentifier = await User.findOne({ identifier });
      if (existingIdentifier) {
        console.log('âš ï¸ Identifier ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ:', identifier);
        return res.status(409).json({ message: 'Ð¢Ð°ÐºÐ¾Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ ÑƒÐ¶Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½' });
      }
  
      console.log('ðŸ” Ð¥ÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð´Ð»Ñ:', username);
      const hashedPassword = await bcrypt.hash(password, 10);
      console.log('âœ… Ð¥ÐµÑˆ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½');
  
      const newUser = new User({
        username,
        password: hashedPassword,
        identifier,
        publicKey,
        identityKey,
        signedPreKey,
        oneTimePreKeys,
        lastSeen: new Date(),
      });
  
      await newUser.save();
      console.log('âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½');
  
      res.status(201).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½' });
    } catch (error) {
      console.error('â— ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸:', error);
      res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
    }
  };


// Ð’Ñ…Ð¾Ð´ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (login)
export const loginUser = async (req, res) => {
  const { username, password } = req.body;

  console.log('ðŸ” ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°:');
  console.log('Username:', username);
  console.log('Password (Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð½Ñ‹Ð¹):', password);

  try {
    const user = await User.findOne({ username });

    if (!user) {
      console.log('âš ï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!');
      return res.status(401).json({ message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ' });
    }

    console.log('âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ...');

    const isMatch = await bcrypt.compare(password, user.password);

    console.log('Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ bcrypt:', isMatch);

    if (!isMatch) {
      console.log('âŒ ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚!');
      return res.status(401).json({ message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ðµ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ' });
    }

    const token = jwt.sign({ userId: user._id }, process.env.JWT_SECRET, {
      expiresIn: '7d'
    });

    console.log('âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð²Ñ…Ð¾Ð´. Ð’Ñ‹Ð´Ð°Ñ‘Ñ‚ÑÑ Ñ‚Ð¾ÐºÐµÐ½.');

    res.json({
      token,
      userId: user._id,
      username: user.username
    });
  } catch (err) {
    console.log('â— ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ:', err.message);
    res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°', error: err.message });
  }
};

// Ð—Ð°Ð¿Ñ€Ð¾Ñ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ
export const resetPasswordRequest = async (req, res) => {
    try {
        const { username } = req.body;
        const user = await User.findOne({ username });

        if (!user) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ°: ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
            return res.status(404).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
        }

        // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð´ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ (6 Ñ†Ð¸Ñ„Ñ€)
        const resetCode = Math.floor(100000 + Math.random() * 900000).toString();
        const resetCodeHash = crypto.createHash('sha256').update(resetCode).digest('hex');
        await User.updateOne(
            { username },
            {
                resetCode: resetCodeHash,
                resetCodeExpires: Date.now() + 15 * 60 * 1000,
            }
        );

        console.log(`ÐšÐ¾Ð´ Ð´Ð»Ñ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ: ${resetCode}`);

        res.json({ message: 'ÐšÐ¾Ð´ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½' });
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ:', error);
        res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ ÑÐ±Ñ€Ð¾ÑÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ' });
    }
};

// ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸ ÑÐ¼ÐµÐ½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ
export const resetPassword = async (req, res) => {
    try {
        const { username, resetCode, newPassword } = req.body;
        const user = await User.findOne({ username });

        if (!user || user.resetCodeExpires < Date.now()) {
            return res.status(400).json({ message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´' });
        }
        const resetCodeHash = crypto.createHash('sha256').update(resetCode).digest('hex');
        if (user.resetCode !== resetCodeHash) {
            return res.status(400).json({ message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ ÑÐ±Ñ€Ð¾ÑÐ°' });
        }

        user.password = await bcrypt.hash(newPassword, 10);
        user.resetCode = undefined;
        user.resetCodeExpires = undefined;
        await user.save();

        res.json({ message: 'ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½' });
    } catch (error) {
        res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ±Ñ€Ð¾ÑÐµ Ð¿Ð°Ñ€Ð¾Ð»Ñ' });
    }
};

// Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ 2FA (OTP-ÐºÐ¾Ð´)
export const enable2FA = async (req, res) => {
    try {
        const user = await User.findById(req.user.userId);
        if (!user) {
            return res.status(404).json({ message: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
        }

        // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð´Ð»Ñ Google Authenticator
        user.twoFactorSecret = crypto.randomBytes(10).toString('hex');
        user.twoFactorEnabled = true;
        await user.save();

        res.json({ message: '2FA Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°', secret: user.twoFactorSecret });
    } catch (error) {
        res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ 2FA' });
    }
};

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° 2FA Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ
export const verify2FA = async (req, res) => {
    try {
        const { username, otp } = req.body;
        const user = await User.findOne({ username });

        if (!user || !user.twoFactorEnabled) {
            return res.status(400).json({ message: '2FA Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°' });
        }

        if (otp !== user.twoFactorSecret) {
            return res.status(401).json({ message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ 2FA' });
        }

        const token = jwt.sign({ userId: user._id }, process.env.JWT_SECRET, { expiresIn: '7d' });
        res.json({ message: '2FA Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð°', token });
    } catch (error) {
        res.status(500).json({ message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ 2FA' });
    }
};

export const generateUniqueIdentifier = (req, res) => {
    const uniqueId = 'id_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
    res.json({ identifier: uniqueId });
  };
